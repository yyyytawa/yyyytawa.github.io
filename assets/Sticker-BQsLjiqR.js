import{c as a,o as d,h,b as l,t as c,i as g,v,F as m,e as k,f as y,j as f,k as w,n as b,_ as p}from"./app-D01Z2m6X.js";import{_}from"./plugin-vue_export-helper-DlAUqK2U.js";const P={name:"Sticker",props:{title:{type:String,default:""},desc:{type:String,default:""},link:{type:String,required:!0},background:{type:String,default:""},page:{type:Number,default:20},prefix:{type:String,default:""},showname:{type:Boolean,default:!0}},data(){return{stickers:[],loading:!0,error:null,configError:null,currentPage:1,localPageSize:this.page,selectedStickers:[],selectAll:!1,downloading:!1,downloadMethod:"stream",generatedFileNames:[]}},computed:{backgroundStyle(){return this.background?this.background.startsWith("http")||this.background.startsWith("/")?`url(${this.background})`:this.background:""},totalPages(){return Math.ceil(this.stickers.length/this.localPageSize)},paginatedStickers(){const t=(this.currentPage-1)*this.localPageSize,e=t+this.localPageSize;return this.stickers.slice(t,e)}},watch:{page(t){this.localPageSize=t},currentPage(){this.selectAll=!1}},async mounted(){await this.initDownloadLibs(),this.fetchStickers()},methods:{async initDownloadLibs(){if(!(typeof window>"u"))try{const t=await p(()=>import("./index-kosvbMQL.js"),[]);this.$downloadZip=t.downloadZip;const e=await p(()=>import("./StreamSaver-ChIg6RIR.js").then(o=>o.S),[]);this.$streamSaver=e.default,this.$streamSaver.mitm="https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"}catch(t){console.error("加载下载库失败:",t),this.downloadMethod="blob"}},async fetchStickers(){try{this.loading=!0;const t=await fetch(this.link,{credentials:"same-origin"});if(!t.ok){this.configError=`获取配置失败: HTTP ${t.status}`;return}const e=await t.json();Array.isArray(e)&&e.every(o=>typeof o=="object"&&o!==null&&o.url)?(this.stickers=e,this.configError=null):(this.configError='JSON 配置格式不正确，期望一个包含 {url: "..."} 对象的数组。',this.stickers=[])}catch(t){this.configError=`加载或解析配置失败: ${t.message}`}finally{this.loading=!1}},getStickerUrl(t){if(!t)return"";try{const e=encodeURI(decodeURIComponent(t));return this.prefix&&!t.startsWith("/")?`${this.prefix.replace(/\/+$/,"")}/${e.replace(/^\/+/,"")}`:e}catch{return t}},handleImageError(t){this.$set(t,"error",!0)},validatePageSize(){this.localPageSize=Math.min(200,Math.max(1,this.localPageSize)),this.currentPage=1},prevPage(){this.currentPage>1&&this.currentPage--},nextPage(){this.currentPage<this.totalPages&&this.currentPage++},toggleSelectAll(){const t=this.paginatedStickers;this.selectedStickers=this.selectAll?[...new Set([...this.selectedStickers,...t])]:this.selectedStickers.filter(e=>!t.includes(e))},updateSelectAll(){this.selectAll=this.paginatedStickers.every(t=>this.selectedStickers.includes(t))},getFileExtension(t){const e=t.split(/[#?]/)[0].split(".");return e.length>1?e.pop().toLowerCase():"png"},getFileName(t){const e=this.getFileExtension(t.url),o=t.name||`sticker-${Date.now()}`;let n=`${o}.${e}`,s=1;for(;this.generatedFileNames.includes(n);)n=`${o}_${s++}.${e}`;return this.generatedFileNames.push(n),n},async downloadAll(){if(!(this.downloading||!this.$downloadZip)){this.downloading=!0,this.error=null,this.generatedFileNames=[];try{const t=this.selectedStickers.length>0?this.selectedStickers:this.stickers;if(t.length===0){this.error="没有可下载的表情包。";return}const e=await Promise.all(t.map(async n=>{if(!n.url)return console.warn("跳过无效URL的表情包:",n),null;try{const s=await fetch(this.getStickerUrl(n.url));if(!s.ok)throw new Error(`HTTP ${s.status} for ${n.url}`);return{name:this.getFileName(n),input:await s.blob(),lastModified:new Date}}catch(s){return console.error(`下载表情包失败: ${n.url}`,s),this.error=`部分表情包下载失败: ${s.message}`,null}})).then(n=>n.filter(s=>s!==null));if(e.length===0){this.error="没有成功下载的表情包用于打包。";return}const o=`sticker-pack-${Date.now()}.zip`;if(this.downloadMethod==="stream"&&this.$streamSaver){const n=this.$streamSaver.createWriteStream(o);await this.$downloadZip(e).body.pipeTo(n)}else{const n=await this.$downloadZip(e).blob(),s=URL.createObjectURL(n),r=document.createElement("a");r.href=s,r.download=o,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(s),100)}}catch(t){this.error=`打包下载失败: ${t.message}`}finally{this.downloading=!1}}}}},E={key:0,class:"sticker-header"},x={key:0},A={class:"controls-section"},z={class:"page-size-selector"},M={class:"pagination-controls"},U=["disabled"],C=["disabled"],N={key:1,class:"loading"},D={key:2,class:"empty-message"},L={key:3,class:"sticker-grid"},T={class:"sticker-checkbox"},F=["value"],R={class:"sticker-img-container"},V=["src","alt","onError"],j={key:0,class:"image-error-tip"},I={key:0,class:"sticker-name"},O={key:4,class:"download-section"},Z={class:"select-controls"},B={class:"selected-count"},W=["disabled"],H={key:0},q={key:1},J={key:5,class:"error-message"};function G(t,e,o,n,s,r){return d(),a("div",{class:"sticker-container",style:b({background:r.backgroundStyle})},[o.title?(d(),a("div",E,[l("h2",null,c(o.title),1),o.desc?(d(),a("p",x,c(o.desc),1)):h("v-if",!0)])):h("v-if",!0),l("div",A,[l("div",z,[e[10]||(e[10]=l("span",null,"每页数量：",-1)),g(l("input",{type:"number","onUpdate:modelValue":e[0]||(e[0]=i=>s.localPageSize=i),min:"1",max:"200",onChange:e[1]||(e[1]=(...i)=>r.validatePageSize&&r.validatePageSize(...i))},null,544),[[v,s.localPageSize,void 0,{number:!0}]])]),l("div",M,[l("button",{onClick:e[2]||(e[2]=(...i)=>r.prevPage&&r.prevPage(...i)),disabled:s.currentPage===1},"上一页",8,U),l("span",null,"第 "+c(s.currentPage)+" 页 / 共 "+c(r.totalPages)+" 页",1),l("button",{onClick:e[3]||(e[3]=(...i)=>r.nextPage&&r.nextPage(...i)),disabled:s.currentPage===r.totalPages},"下一页",8,C)])]),s.loading?(d(),a("div",N,"加载表情包配置中...")):s.stickers.length===0?(d(),a("div",D,[s.configError?(d(),a(m,{key:0},[k(c(s.configError),1)],64)):(d(),a(m,{key:1},[k(" 没有找到表情包，请检查配置文件 ")],64))])):(d(),a("div",L,[(d(!0),a(m,null,y(r.paginatedStickers,(i,S)=>(d(),a("div",{key:S,class:"sticker-item"},[l("div",T,[g(l("input",{type:"checkbox","onUpdate:modelValue":e[4]||(e[4]=u=>s.selectedStickers=u),value:i,onChange:e[5]||(e[5]=(...u)=>r.updateSelectAll&&r.updateSelectAll(...u))},null,40,F),[[f,s.selectedStickers]])]),l("div",R,[l("img",{src:r.getStickerUrl(i.url),alt:i.name||"表情包",loading:"lazy",onError:u=>r.handleImageError(i)},null,40,V),i.error?(d(),a("div",j,"加载失败")):h("v-if",!0)]),o.showname&&i.name?(d(),a("div",I,c(i.name),1)):h("v-if",!0)]))),128))])),s.stickers.length>0?(d(),a("div",O,[l("div",Z,[l("label",null,[g(l("input",{type:"checkbox","onUpdate:modelValue":e[6]||(e[6]=i=>s.selectAll=i),onChange:e[7]||(e[7]=(...i)=>r.toggleSelectAll&&r.toggleSelectAll(...i))},null,544),[[f,s.selectAll]]),e[11]||(e[11]=k(" 全选当前页 ",-1))]),l("span",B,"已选 "+c(s.selectedStickers.length)+" 个",1),g(l("select",{"onUpdate:modelValue":e[8]||(e[8]=i=>s.downloadMethod=i),class:"download-method"},[...e[12]||(e[12]=[l("option",{value:"stream"},"流式下载(推荐)",-1),l("option",{value:"blob"},"普通下载",-1)])],512),[[w,s.downloadMethod]])]),l("button",{onClick:e[9]||(e[9]=(...i)=>r.downloadAll&&r.downloadAll(...i)),disabled:s.downloading||s.selectedStickers.length===0,class:"download-btn"},[s.downloading?(d(),a("span",H,"打包中...")):(d(),a("span",q,"下载选中表情包 ("+c(s.selectedStickers.length||"全部")+")",1))],8,W)])):h("v-if",!0),s.error?(d(),a("div",J,c(s.error),1)):h("v-if",!0)],4)}const X=_(P,[["render",G],["__scopeId","data-v-0f566dda"]]);export{X as S};
